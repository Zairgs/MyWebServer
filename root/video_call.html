<!DOCTYPE html>
<html lang="zh-CN">
<html>

<head>
    <meta charset="UTF-8">
    <title>WebRTC Video Call</title>
    <style>
        #video-container {
            display: flex;
            flex-wrap: wrap;
        }

        video {
            width: 45%;
            margin: 10px;
            background: #000;
        }

        #controls {
            margin: 20px;
        }

        button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>WebRTC Video Call</h1>

    <div>
        <label for="roomId">房间 ID:</label>
        <input type="text" id="roomId" value="default_room">
        <button id="joinBtn">加入房间</button>
    </div>

    <div id="video-container">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="controls" style="display:none;">
        <button id="startBtn">开始呼叫</button>
        <button id="hangupBtn">挂断</button>
    </div>

    <script>
        // 检测是否在 localhost 上
        function isLocalhost() {
            return window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1';
        }

        // 特殊处理 localhost
        function ensureMediaAccess() {
            if (isLocalhost() && !navigator.mediaDevices) {
                // 尝试重新定义 mediaDevices
                navigator.mediaDevices = {};

                // 添加 getUserMedia 支持
                navigator.mediaDevices.getUserMedia = function (constraints) {
                    return new Promise((resolve, reject) => {
                        const getUserMedia = navigator.webkitGetUserMedia ||
                            navigator.mozGetUserMedia;

                        if (!getUserMedia) {
                            reject(new Error('getUserMedia is not implemented in this browser'));
                            return;
                        }

                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                };

                console.warn("Using legacy getUserMedia API for localhost");
            }
        }

        // 在页面加载时调用
        document.addEventListener('DOMContentLoaded', ensureMediaAccess);
        // 配置 STUN 服务器
        const config = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" }
            ]
        };

        // DOM 元素
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const roomIdInput = document.getElementById('roomId');
        const joinBtn = document.getElementById('joinBtn');
        const startBtn = document.getElementById('startBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const controlsDiv = document.getElementById('controls');

        // 全局变量
        let localStream;
        let peerConnection;
        let roomId;
        let isCaller = false;

        // 加入房间
        joinBtn.onclick = async () => {
            roomId = roomIdInput.value;
            if (!roomId) {
                alert('Please enter a room ID');
                return;
            }

            try {
                // 获取本地媒体流
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                localVideo.srcObject = localStream;
                controlsDiv.style.display = 'block';
                joinBtn.disabled = true;

                // 检查是否第一个加入房间
                const response = await fetch(`/webrtc/${roomId}/offer`);

                if (response.status === 200) {
                    // 房间已存在，加入为接收者
                    const data = await response.json();
                    await handleOffer(data.sdp);
                } else {
                    // 房间不存在，创建为发起者
                    isCaller = true;
                }
            } catch (err) {
                console.error('Error joining room:', err);
                alert(`Error: ${err.message}`);
            }
        };

        // 开始呼叫
        startBtn.onclick = async () => {
            if (!isCaller) return;

            try {
                createPeerConnection();

                // 添加本地流
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // 创建 offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // 发送 offer 到服务器
                await fetch(`/webrtc/${roomId}/offer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(offer)
                });

                startBtn.disabled = true;
            } catch (err) {
                console.error('Error starting call:', err);
            }
        };

        // 挂断
        hangupBtn.onclick = () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
            }

            remoteVideo.srcObject = null;
            controlsDiv.style.display = 'none';
            joinBtn.disabled = false;
            startBtn.disabled = false;
        };

        // 处理接收到的 offer
        async function handleOffer(offerSdp) {
            try {
                createPeerConnection();

                // 添加本地流
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // 设置远程 offer
                await peerConnection.setRemoteDescription(
                    new RTCSessionDescription(JSON.parse(offerSdp))
                );

                // 创建 answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // 发送 answer 到服务器
                await fetch(`/webrtc/${roomId}/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(answer)
                });

                // 获取并添加 ICE 候选
                fetchCandidates();
            } catch (err) {
                console.error('Error handling offer:', err);
            }
        }

        // 创建 PeerConnection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            // ICE 候选处理
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    fetch(`/webrtc/${roomId}/candidate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(event.candidate)
                    });
                }
            };

            // 远程流处理
            peerConnection.ontrack = event => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // 连接状态变化
            peerConnection.oniceconnectionstatechange = () => {
                if (peerConnection.iceConnectionState === 'disconnected' ||
                    peerConnection.iceConnectionState === 'failed') {
                    hangupBtn.click();
                }
            };
        }

        // 获取并添加 ICE 候选
        async function fetchCandidates() {
            try {
                const response = await fetch(`/webrtc/${roomId}/candidate`);
                if (response.status !== 200) return;

                const data = await response.json();
                for (const candidate of data.candidates) {
                    try {
                        await peerConnection.addIceCandidate(
                            new RTCIceCandidate(JSON.parse(candidate))
                        );
                    } catch (err) {
                        console.warn('Error adding ICE candidate:', err);
                    }
                }

                // 继续轮询
                setTimeout(fetchCandidates, 1000);
            } catch (err) {
                console.error('Error fetching candidates:', err);
                setTimeout(fetchCandidates, 2000);
            }
        }
    </script>
</body>

</html>